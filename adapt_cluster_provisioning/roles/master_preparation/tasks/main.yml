---
# Admin user should be present, uid 1000, and no other users on the master

# Master preparation tasks to make it a mirror
- name: Setup galaxy user
  user: name=galaxy comment="Galaxy user" uid=1001 state=present shell=/bin/bash
- name: Create galaxy mount point for nginx and other mount points
  file: path={{ item }} state=directory
  with_flattened: mount_paths
  
- name: Install packages for master
  apt: pkg={{ item }} state=installed
  with_items: master_packages
- name: Install packages required for building
  apt: pkg={{ item }} state=installed
  with_items: build_packages # from core vars file

- name: Install virtualenv
  pip: name=virtualenv state=present



# Install ansible
- name: Install ansible on master for worker installations
  pip: name=ansible state=present virtualenv=/home/admin/virtenvs/ansible
- name: Get latest stable ansible scripts from github
  git: repo=git://github.com/glormph/proteomics_configuration
       dest=/home/admin/proteomics_configuration
- name: Move hosts file to repo on host
  copy: src=inventory/hosts
        dest=/home/admin/proteomics_configuration/adapt_cluster_provisioning/inventory/hosts
- name: Move clusterdata to repo on host
  copy: src=inventory/cluster_data.yml
        dest=/home/admin/proteomics_configuration/adapt_cluster_provisioning/inventory/cluster_data.yml

# Prepare munge key
- name: Create mungekey
  shell: dd if=/dev/urandom bs=1 count=1024 >/home/admin/mungekey

- name: Make new admin homedir contents owned by admin user
  file: path=/home/admin/virtenvs state=directory owner=admin group=admin recurse=yes
  file: path=/home/admin/proteomics_configuration state=directory owner=admin group=admin recurse=yes
