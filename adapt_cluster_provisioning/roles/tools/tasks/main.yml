---
# Installation of tools for galaxy. In future, from toolshed!

- name: Install tool build packages
  apt: pkg={{ item }} state=installed
  with_items: tool_build_packages

# MSGF+ installation
- name: Fetch MSGFPlus java package
  get_url: url={{ msgf_url }} dest=/tmp/msgfplus.zip
- name: Unzip MSGFPlus
  command: unzip /tmp/msgfplus.zip MSGFPlus.jar -d /tmp/ creates=/tmp/MSGFPlus.jar
- name: Create msgf tool path
  file: path={{ tool_path }}/{{ msgf_pkg }}/{{ msgf_ver }} state=directory
- name: Install MSGFPlus
  command: mv /tmp/MSGFPlus.jar {{ tool_path }}/{{ msgf_pkg }}/{{ msgf_ver }}
- include: tool_dependency_fixer.yml toolpath={{ tool_path }}/{{ msgf_pkg }}/{{ msgf_ver }} envdest={{ tool_path }}/{{ msgf_pkg }}/{{ msgf_ver }} toolroot={{ tool_path }}/{{ msgf_pkg }} ldline="#"

# Percolator
- name: Get percolator source 
  get_url: url={{ percolator_url }} dest=/tmp/percolator.tar.gz 
- name: Create percolator tool path
  file: path={{ tool_path }}/{{ percolator_path}}/bin state=directory
- name: Untar source
  command: tar xvfz percolator.tar.gz chdir=/tmp/
- name: Cmake percolator
  command: cmake -DTARGET_ARCH=amd64 -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX={{ tool_path }}/{{ percolator_path }} -DXML_SUPPORT=ON /tmp/{{ percolator_src }} chdir={{ tool_path }}/{{ percolator_path }}
- name: Make percolator
  command: make -j 4 chdir={{ tool_path }}/{{ percolator_path }}
- name: Make install percolator
  command: make install chdir={{ tool_path }}/{{ percolator_path }}
- include: tool_dependency_fixer.yml toolpath={{ tool_path }}/{{ percolator_path }}/bin envdest={{ tool_path }}/{{ percolator_path }} toolroot={{ tool_path }}/{{ percolator_pkg }} ldline="#"

# percolator converters
- name: Create percolator converter tool path
  file: path={{ tool_path }}/{{ perconvert_path}}/bin state=directory
- name: Cmake percolator converters
  command: cmake -DTARGET_ARCH=amd64 -DCMAKE_INSTALL_PREFIX={{ tool_path }}/{{ perconvert_path }} -DCMAKE_BUILD_TYPE=Release -DSERIALIZE="TokyoCabinet" /tmp/{{ percolator_src }}/src/converters chdir={{ tool_path }}/{{ perconvert_path }}
- name: Make percolator converters
  command: make chdir={{ tool_path }}/{{ perconvert_path }}
- name: Make install percolator converters
  command: make install chdir={{ tool_path }}/{{ perconvert_path }}
- include: tool_dependency_fixer.yml toolpath={{ tool_path }}/{{ perconvert_path }}/bin envdest={{ tool_path }}/{{ perconvert_path}} toolroot={{ tool_path }}/{{ perconvert_pkg }} ldline="#"

# Pout2mzid
- name: Create pout2mzid tool path
  file: path={{ pout2mzid_loc }}/bin state=directory
- name: Get pout2mzid source
  git: repo={{ pout2mzid_repo }} version={{ pout2mzid_commit }} dest=/tmp/pout2mzid_src
- name: Cmake pout2mzid
  command: cmake /tmp/pout2mzid_src/CMakeLists.txt -B chdir={{ pout2mzid_loc }}/bin
- name: Make pout2mzid
  command: make chdir={{ pout2mzid_loc }}/bin
- include: tool_dependency_fixer.yml toolpath={{ pout2mzid_loc }}/bin envdest={{ pout2mzid_loc }} toolroot={{ tool_path }}/{{ pout2mzid_pkg }} ldline="#"


# Install proteowizard
- name: Create proteowizard tool path
  file: path={{ pwiz_loc }}/bin state=directory
- name: Get proteowizard
  shell: curl --data "downloadtype=bt17" http://data.mallicklab.com/download.php > /tmp/pwizard.tar.bz2
- name: Unzip proteowizard
  command: tar xjf /tmp/pwizard.tar.bz2 chdir={{ pwiz_loc }}/bin
- include: tool_dependency_fixer.yml toolpath={{ pwiz_loc }}/bin envdest={{ pwiz_loc }} toolroot={{ tool_path }}/{{ pwiz_pkg }} ldline="#"  


- name: Fix ownership of all tools
  file: path={{ tool_path }} owner=galaxy group=galaxy recurse=yes state=directory

